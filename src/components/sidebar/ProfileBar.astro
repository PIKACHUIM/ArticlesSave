---  
import { USER_AVATAR, USER_SIDEBAR_SOCIAL_ICONS, umamiConfig } from "../../config";  
import { Icon } from "astro-icon/components";   
import { Image } from "astro:assets";  
import { getAllPosts, getCategoriesWithPosts, getTagsWithCount } from "@utils/blogUtils";  
  
// è·å–æ‰€æœ‰åšå®¢æ–‡ç« å’Œåˆ†ç±»ä¿¡æ¯  
const allPosts = await getAllPosts();  
const categoryMap = getCategoriesWithPosts(allPosts);  
const categoryEntries = Array.from(categoryMap.entries());  
  
// ä¿®æ”¹åˆ†ç±»æ’åºï¼šæŒ‰æ–‡ç« æ•°é‡ä»é«˜åˆ°ä½æ’åº  
categoryEntries.sort((a, b) => b[1].length - a[1].length);
  
// åˆ†ç±»åç§°æ˜ å°„ï¼šè‹±æ–‡åˆ°ä¸­æ–‡  
const categoryNameMap = {  
  "Course": "æ•™ç¨‹",  
  "Anime": "åŠ¨æ¼«",   
  "TV": "ç”µè§†å‰§",  
  "Documentation": "æ–‡æ¡£",  
  "Examples": "ç¤ºä¾‹",  
  "Tutorial": "æ•™ç¨‹",  
  "Tech": "æŠ€æœ¯",  
  "Life": "ç”Ÿæ´»",  
  "Blog": "åšå®¢",  
  "Project": "é¡¹ç›®",  
  "Note": "ç¬”è®°",  
  "Review": "è¯„æµ‹"  
}; 

// è·å–æ ‡ç­¾ä¿¡æ¯  
const tagMap = getTagsWithCount(allPosts);  
const tagEntries = Array.from(tagMap.entries());  
tagEntries.sort((a, b) => b[1] - a[1]); // æŒ‰ä½¿ç”¨é¢‘ç‡æ’åº
  
// è·å–ä¸­æ–‡åˆ†ç±»åç§°çš„å‡½æ•°  
const getCategoryDisplayName = (category: string): string => {  
  return (categoryNameMap as Record<string, string>)[category] || category;  
}; 
---  
  
<!-- ç¬¬ä¸€ä¸ªç›’å­ï¼šç”¨æˆ·ä¿¡æ¯ -->  
<div class="card-base p-3 mb-4">  
  <!-- å¤´åƒåŒºåŸŸ -->  
  <a   
    aria-label="Go to About Page"   
    href="/about/"   
    class="group block relative mx-auto mt-1 lg:mx-0 lg:mt-0 mb-3 max-w-[12rem] lg:max-w-none overflow-hidden rounded-xl active:scale-95"  
  >  
    <!-- æ‚¬åœé®ç½©å±‚ -->  
    <div class="absolute transition pointer-events-none group-hover:bg-black/30 group-active:bg-black/50 w-full h-full z-50 flex items-center justify-center">  
      <Icon   
        name="material-symbols:person-outline"   
        class="transition opacity-0 scale-90 group-hover:scale-100 group-hover:opacity-100 text-white text-5xl"   
      />  
    </div>  
      
    <!-- å¤´åƒå›¾ç‰‡å®¹å™¨ -->  
    <div class="mx-auto lg:w-full h-full lg:mt-0 overflow-hidden relative image-wrapper">  
      <!-- åŠ è½½æ¡ -->  
      <div class="loading-bar absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-32 h-1 bg-gray-200 dark:bg-gray-700 z-10 rounded-full overflow-hidden" style="opacity: 0;">  
        <div class="loading-progress h-full w-8 bg-primary animate-pulse rounded-full"></div>  
      </div>  
        
      <!-- å›¾ç‰‡é®ç½© -->  
      <div class="transition absolute inset-0 dark:bg-black/10 bg-opacity-50 pointer-events-none"></div>  
        
      <!-- å¤´åƒå›¾ç‰‡ -->  
      <Image  
        src={USER_AVATAR}  
        alt="Profile Image of the Author"  
        class="w-full h-full object-cover image-content opacity-0 transition-opacity duration-500"  
        style="object-position: center center; opacity: 1;"  
        width={250}  
        height={250}  
        format="webp"  
        loading="eager"  
        onload="this.style.opacity='1'; this.parentElement.querySelector('.loading-bar').style.opacity='0';"  
      />  
    </div>  
  </a>  
    
  <!-- ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ -->  
  <div class="px-2">  
    <!-- ç”¨æˆ·å -->  
    <div class="font-bold text-xl text-center mb-1 dark:text-neutral-50 transition">  
      Pikachu Ren
    </div>  
      
    <!-- è£…é¥°çº¿æ¡ -->  
    <div class="h-1 w-5 bg-primary mx-auto rounded-full mb-2 transition"></div>  
      
    <!-- ä¸ªäººæè¿° -->  
    <!-- <div class="text-center text-base-content/60 mb-2.5 transition">  
      æ¬²ä¹°æ¡‚èŠ±åŒè½½é…’~âœ¨  
    </div>   -->
    <!-- ä¸ªäººæè¿° -->       
    <div class="text-center mb-2.5 transition font-bold tracking-wide bg-gradient-to-r from-pink-400 to-purple-400 bg-clip-text text-transparent hover:scale-105 hover:from-purple-400 hover:to-pink-400">      
     çš®å¡~çš®å¡~çš®å¡ä¸˜ğŸµï¼
    </div>
      
    <!-- ç¤¾äº¤å›¾æ ‡ - æ¢å¤åŸå§‹æ ·å¼ -->  
    <div class="mt-4 pt-3 border-t border-base-content/20">  
      <div class="grid grid-cols-4 md:grid-cols-2 lg:grid-cols-4 gap-2 justify-items-center">  
        {USER_SIDEBAR_SOCIAL_ICONS.map((icon) => (  
          <div class="tooltip tooltip-bottom" data-tip={icon.title}>  
            <a  
              tabindex="0"  
              href={icon.href}  
              aria-label={icon.ariaLabel}  
              target="_blank"  
              class="btn btn-circle btn-ghost"  
            >  
              <Icon name={icon.svg} class="text-xl" />  
            </a>  
          </div>  
        ))}  
      </div>  
    </div>  
      
    <!-- å…¨ç«™è®¿é—®é‡ç»Ÿè®¡ -->  
    <div class="text-center text-sm text-base-content/50 mt-3 pt-3 border-t border-base-content/20">  
      <div class="flex items-center justify-center gap-1">  
        <Icon name="material-symbols:visibility-outline" class="text-base" />  
        <span id="site-stats">åŠ è½½ä¸­...</span>  
      </div>  
    </div>  
  </div>  
</div>  
  
<!-- ç¬¬äºŒä¸ªç›’å­ï¼šåˆ†ç±»åˆ—è¡¨ -->  
<div class="card-base p-3 mb-4">  
  <div class="font-bold transition text-lg text-base-content relative ml-4 mb-2 before:w-1 before:h-4 before:rounded-md before:bg-primary before:absolute before:left-[-16px] before:top-[5.5px]">  
    åˆ†ç±»  
  </div>  
    
  <div id="categories" class="collapse-wrapper px-2 overflow-hidden" style="--collapsedHeight: 7.5rem;">  
    {categoryEntries.slice(0, 3).map(([category, posts]) => (  
      <a href={`/blog/category/${category}`} aria-label={`View all posts in the ${category} category`}>  
        <button class="w-full h-10 rounded-lg bg-none hover:bg-base-200 active:bg-base-300 transition-all pl-2 hover:pl-3 text-base-content hover:text-primary">  
          <div class="flex items-center justify-between relative mr-2">  
            <div class="overflow-hidden text-left whitespace-nowrap overflow-ellipsis">  
              {getCategoryDisplayName(category)}  
            </div>  
            <div class="transition px-2 h-7 ml-4 min-w-[2rem] rounded-lg text-sm font-bold text-base-content bg-base-200 flex items-center justify-center">  
              {posts.length}  
            </div>  
          </div>  
        </button>  
      </a>  
    ))}  
      
    {categoryEntries.length > 3 && (  
      <div class="hidden-categories" style="display: none;">  
        {categoryEntries.slice(3).map(([category, posts]) => (  
          <a href={`/blog/category/${category}`} aria-label={`View all posts in the ${category} category`}>  
            <button class="w-full h-10 rounded-lg bg-none hover:bg-base-200 active:bg-base-300 transition-all pl-2 hover:pl-3 text-base-content hover:text-primary">  
              <div class="flex items-center justify-between relative mr-2">  
                <div class="overflow-hidden text-left whitespace-nowrap overflow-ellipsis">  
                  {getCategoryDisplayName(category)}  
                </div>  
                <div class="transition px-2 h-7 ml-4 min-w-[2rem] rounded-lg text-sm font-bold text-base-content bg-base-200 flex items-center justify-center">  
                  {posts.length}  
                </div>  
              </div>  
            </button>  
          </a>  
        ))}  
      </div>  
    )}  
  </div>  
    
  <!-- åˆ†ç±»å±•å¼€æŒ‰é’® -->  
  {categoryEntries.length > 3 && (  
    <div class="expand-btn px-2 -mb-2">  
      <button class="btn btn-ghost rounded-lg w-full h-9" id="expand-categories">  
        <div class="text-primary flex items-center justify-center">  
          ... æ›´å¤š  
        </div>  
      </button>  
    </div>  
  )}   
</div> 

<!-- ç¬¬ä¸‰ä¸ªç›’å­ï¼šæ ‡ç­¾åˆ—è¡¨ -->  
<div class="card-base p-3">  
  <div class="font-bold transition text-lg text-base-content relative ml-4 mb-2 before:w-1 before:h-4 before:rounded-md before:bg-primary before:absolute before:left-[-16px] before:top-[5.5px]">  
    æ ‡ç­¾  
  </div>  
    
  <div id="tags" class="collapse-wrapper px-2 overflow-hidden" style="--collapsedHeight: 7.5rem;">  
    <div class="flex gap-1 flex-wrap">  
      {tagEntries.slice(0, 8).map(([tag]) => (  
        <a href={`/blog/tag/${tag}`} aria-label={`View all posts with the ${tag} tag`} class="h-6 text-base px-2 rounded-md border border-secondary text-base-content hover:bg-secondary hover:text-secondary-content hover:scale-110 transition-all inline-flex items-center justify-center">  
          {tag}  
        </a>
      ))}  
    </div>  
      
    {tagEntries.length > 8 && (  
      <div class="hidden-tags" style="display: none;">  
        <div class="flex gap-1 flex-wrap mt-1">  
          {tagEntries.slice(8).map(([tag]) => (
            <a href={`/blog/tag/${tag}`} aria-label={`View all posts with the ${tag} tag`} class="h-6 text-base px-2 rounded-md border border-secondary text-base-content hover:bg-secondary hover:text-secondary-content hover:scale-110 transition-all inline-flex items-center justify-center">  
              {tag}  
            </a>  
          ))}  
        </div>  
      </div>  
    )}  
  </div>  
    
  {tagEntries.length > 8 && (  
    <div class="expand-btn px-2 -mb-2">  
      <button class="btn btn-ghost rounded-lg w-full h-9" id="expand-tags">  
        <div class="text-primary flex items-center justify-center">  
          ... æ›´å¤š  
        </div>  
      </button>  
    </div>  
  )}  
</div>
  
<script is:inline define:vars={{ umamiConfig }}> 
  // ä½¿ç”¨ sessionStorage æ¥é¿å…é‡å¤åŠ è½½  
  let statsData = null;  
    
  // è·å–å…¨ç«™è®¿é—®é‡ç»Ÿè®¡  
  async function loadSiteStats() {  
    if (!umamiConfig.enable) {  
      return;  
    }  
      
    // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰ç¼“å­˜çš„æ•°æ®  
    const cachedStats = sessionStorage.getItem('siteStatsData');  
    if (cachedStats) {  
      statsData = JSON.parse(cachedStats);  
      updateStatsDisplay();  
      return;  
    }  
          
    try {  
      // ç¬¬ä¸€æ­¥ï¼šè·å–ç½‘ç«™IDå’Œtoken  
      const shareResponse = await fetch(`${umamiConfig.baseUrl}/api/share/${umamiConfig.shareId}`);  
      if (!shareResponse.ok) {  
        throw new Error('è·å–åˆ†äº«ä¿¡æ¯å¤±è´¥');  
      }  
      const shareData = await shareResponse.json();  
      const { websiteId, token } = shareData;  
            
      // ç¬¬äºŒæ­¥ï¼šè·å–å…¨ç«™ç»Ÿè®¡æ•°æ®  
      const currentTimestamp = Date.now();  
      const statsUrl = `${umamiConfig.baseUrl}/api/websites/${websiteId}/stats?startAt=0&endAt=${currentTimestamp}&unit=hour&timezone=${encodeURIComponent(umamiConfig.timezone)}&compare=false`;  
            
      const statsResponse = await fetch(statsUrl, {  
        headers: {  
          'x-umami-share-token': token  
        }  
      });  
            
      if (!statsResponse.ok) {  
        throw new Error('è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥');  
      }  
            
      const responseData = await statsResponse.json();  
      const pageviews = responseData.pageviews?.value || 0;  
      const visitors = responseData.visits?.value || 0;  
        
      // ç¼“å­˜æ•°æ®  
      statsData = { pageviews, visitors };  
      sessionStorage.setItem('siteStatsData', JSON.stringify(statsData));  
        
      updateStatsDisplay();  
    } catch (error) {  
      console.error('è·å–å…¨ç«™ç»Ÿè®¡å¤±è´¥:', error);  
      statsData = { error: true };  
      sessionStorage.setItem('siteStatsData', JSON.stringify(statsData));  
      updateStatsDisplay();  
    }  
  }  
    
  // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º  
  function updateStatsDisplay() {  
    const statsElement = document.getElementById('site-stats');  
    if (statsElement && statsData) {  
      if (statsData.error) {  
        statsElement.textContent = 'ç»Ÿè®¡ä¸å¯ç”¨';  
      } else {  
        statsElement.textContent = `æµè§ˆé‡ ${statsData.pageviews} Â· è®¿é—®æ•° ${statsData.visitors}`;  
      }  
    }  
  }  
    
  // åˆ†ç±»å±•å¼€/æŠ˜å åŠŸèƒ½      
function initCategoriesToggle() {      
  const expandBtn = document.getElementById('expand-categories');      
  const hiddenCategories = document.querySelector('.hidden-categories');      
          
  if (expandBtn && hiddenCategories) {      
    let isExpanded = false;      
            
    expandBtn.addEventListener('click', () => {      
      const btnDiv = expandBtn.querySelector('div');    
      if (isExpanded) {      
        hiddenCategories.style.display = 'none';  
        btnDiv.className = 'text-primary flex items-center justify-center';  
        btnDiv.textContent = '... æ›´å¤š';      
      } else {      
        hiddenCategories.style.display = 'block';  
        btnDiv.className = 'text-primary flex items-center justify-center';  
        btnDiv.textContent = 'â® æ”¶èµ·';      
      }      
      isExpanded = !isExpanded;      
    });      
  }      
}
  
 // æ ‡ç­¾å±•å¼€/æŠ˜å åŠŸèƒ½      
function initTagsToggle() {      
  const expandBtn = document.getElementById('expand-tags');      
  const hiddenTags = document.querySelector('.hidden-tags');      
  
  if (expandBtn && hiddenTags) {      
    let isExpanded = false;      
    
    expandBtn.addEventListener('click', () => {      
      const btnDiv = expandBtn.querySelector('div');    
      if (isExpanded) {      
        hiddenTags.style.display = 'none';  
        btnDiv.className = 'text-primary flex items-center justify-center';  
        btnDiv.textContent = '... æ›´å¤š';      
      } else {      
        hiddenTags.style.display = 'block';  
        btnDiv.className = 'text-primary flex items-center justify-center';  
        btnDiv.textContent = 'â® æ”¶èµ·';      
      }      
      isExpanded = !isExpanded;      
    });      
  }      
}

  // åˆå§‹åŒ–å‡½æ•°  
  function init() {  
    // å¦‚æœå·²æœ‰ç¼“å­˜æ•°æ®ï¼Œç«‹å³æ˜¾ç¤º  
    const cachedStats = sessionStorage.getItem('siteStatsData');  
    if (cachedStats) {  
      statsData = JSON.parse(cachedStats);  
      updateStatsDisplay();  
    } else {  
      // å¦åˆ™åŠ è½½æ–°æ•°æ®  
      loadSiteStats();  
    }  
      
    // åˆå§‹åŒ–åˆ†ç±»åˆ‡æ¢åŠŸèƒ½  
    initCategoriesToggle(); 
    // åˆå§‹åŒ–æ ‡ç­¾åˆ‡æ¢åŠŸèƒ½  
    initTagsToggle() 
  }  
    
  // DOM åŠ è½½å®Œæˆååˆå§‹åŒ–  
  if (document.readyState === 'loading') {  
    document.addEventListener('DOMContentLoaded', init);  
  } else {  
    init();  
  }  
    
  // ç›‘å¬ Astro é¡µé¢è½¬æ¢äº‹ä»¶  
  document.addEventListener('astro:page-load', () => {  
    // é¡µé¢åˆ‡æ¢æ—¶é‡æ–°åˆå§‹åŒ–  
    init();  
  });  
</script> 
  
<style>  
.card-base {  
  @apply bg-base-100 rounded-xl shadow-lg border border-base-200;  
}  
  
.loading-progress {  
  animation: loading-progress 2s ease-in-out infinite;  
}  
  
@keyframes loading-progress {  
  0% { transform: translateX(-100%); }  
  50% { transform: translateX(0%); }  
  100% { transform: translateX(100%); }  
}  
</style>